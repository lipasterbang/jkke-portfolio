<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jana BQ & Anggaran Kos | JKKE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --bg-body: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-body); color: #1e293b;
        }

        nav.navbar {
            background-color: var(--primary); color: white; padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px; margin: 30px auto; padding: 0 20px;
            display: grid; grid-template-columns: 1fr 3fr; gap: 25px;
        }

        /* Sidebar */
        .estimator-card {
            background: var(--white); padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: fit-content;
            border-top: 5px solid var(--secondary);
        }

        /* Main Content */
        .bq-card {
            background: var(--white); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .bq-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

        /* Table Styling with Nested Headers */
        table.bq-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        
        table.bq-table th { 
            text-align: center; padding: 12px; 
            background: #f8fafc; color: var(--primary); 
            font-weight: 700; border: 1px solid var(--border); 
            vertical-align: middle;
        }
        
        table.bq-table td { 
            padding: 10px; border: 1px solid var(--border); 
            vertical-align: middle; 
        }

        .qty-input { width: 60px; padding: 6px; text-align: center; border: 1px solid var(--border); border-radius: 4px; }
        .total-row { background: #fef9c3; font-weight: 700; font-size: 1.1rem; color: var(--primary); }

        .action-bar { margin-top: 25px; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-print { background: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display:flex; gap:8px; align-items:center; }
        .btn-reset { background: var(--danger); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand"><i class="fa-solid fa-file-invoice-dollar"></i> PENGURUSAN BQ</div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="bq.html" style="color: white; text-decoration: none; position: relative; font-size: 1.1rem;">
                <i class="fa-solid fa-cart-shopping"></i>
                <span id="cartCountBadge" style="position: absolute; top: -10px; right: -12px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;">0</span>
            </a>
            <button onclick="window.location.href='jkke.html'" style="background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;">
                <i class="fa-solid fa-house"></i> Home
            </button>
        </div>
    </nav>

    <div class="container">
        
        <aside class="estimator-card">
            <h3><i class="fa-solid fa-clipboard-check"></i> Ringkasan Projek</h3>
            <div style="padding: 15px 0;">
                <p>Bilangan Item: <strong id="summaryCount">0</strong></p>
                <p>Tarikh Jana: <strong><span id="currentDate"></span></strong></p>
                <hr>
                <p style="font-size: 0.9rem; color: #64748b;">Gunakan butang di bawah untuk muat turun dokumen rasmi Lampiran C.</p>
            </div>
        </aside>

        <main class="bq-card">
            <div class="bq-header">
                <h2>Senarai Kadar Harga (BQ)</h2>
                <div style="font-size:0.9rem; color:#64748b;">Tarikh: <span id="currentDateDisplay"></span></div>
            </div>

            <table class="bq-table">
                <thead>
                    <tr>
                        <th rowspan="2" width="5%">No</th>
                        <th rowspan="2" width="40%">Keterangan</th>
                        <th colspan="3" width="20%">JKKE</th>
                        <th rowspan="2" width="10%">Kuantiti</th>
                        <th rowspan="2" width="15%">Harga (RM)</th>
                        <th rowspan="2" width="10%">Tindakan</th>
                    </tr>
                    <tr>
                        <th>Bhg.</th>
                        <th>Bil.</th>
                        <th>RM</th>
                    </tr>
                </thead>
                <tbody id="bqTableBody">
                    </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="6" style="text-align:right; padding-right:20px;">JUMLAH BESAR:</td>
                        <td style="text-align:right;" id="grandTotal">0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <div id="emptyState" style="text-align:center; padding:40px; color:#94a3b8; display:none;">
                <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:15px;"></i>
                <p>Senarai BQ kosong. Sila pilih item dari Katalog dahulu.</p>
                <button onclick="window.location.href='semuajkke.html'" class="btn-print" style="width:auto; margin:10px auto; background: var(--secondary);">Pergi ke Katalog</button>
            </div>

            <div class="action-bar">
                <button class="btn-reset" onclick="clearBQ()"><i class="fa-solid fa-trash"></i> Kosongkan</button>
                <button class="btn-print" onclick="generatePDF()"><i class="fa-solid fa-file-pdf"></i> Muat Turun PDF</button>
            </div>
        </main>

    </div>

    <script>
        const CART_KEY = 'projectCart'; // Kunci seragam untuk localStorage

        // 1. Initialization
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toLocaleDateString('ms-MY');
            document.getElementById('currentDate').innerText = today;
            document.getElementById('currentDateDisplay').innerText = today;
            loadBQFromStorage();
        });

        // 2. Load & Render Data
        function loadBQFromStorage() {
            const storedData = localStorage.getItem(CART_KEY);
            const bqItems = storedData ? JSON.parse(storedData) : [];
            const tbody = document.getElementById('bqTableBody');
            
            tbody.innerHTML = '';
            let grandTotal = 0;

            // Update Badge
            document.getElementById('cartCountBadge').innerText = bqItems.length;
            document.getElementById('summaryCount').innerText = bqItems.length;

            if (bqItems.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.querySelector('.bq-table').style.display = 'none';
                document.querySelector('.action-bar').style.display = 'none';
                return;
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.querySelector('.bq-table').style.display = 'table';
                document.querySelector('.action-bar').style.display = 'flex';
            }

            bqItems.forEach((item, index) => {
                // Logic Pecahkan Kod (Contoh: 1A1 -> Bhg:1, Bil:A1)
                const bhg = item.code.charAt(0);
                const bil = item.code.substring(1);
                
                let price = parseFloat(item.price);
                let qty = parseInt(item.quantity) || 1; 
                let total = price * qty;
                grandTotal += total;

                let row = `
                    <tr>
                        <td style="text-align:center;">${index + 1}</td>
                        <td>
                            <div style="font-weight:600; color:#1e3a8a; font-size:0.85rem;">[${item.code}]</div>
                            ${item.description}
                        </td>
                        <td style="text-align:center;">${bhg}</td>
                        <td style="text-align:center;">${bil}</td>
                        <td style="text-align:right;">${price.toFixed(2)}</td>
                        <td style="text-align:center;">
                            <input type="number" class="qty-input" value="${qty}" min="1" onchange="updateQty(${index}, this.value)">
                        </td>
                        <td style="text-align:right; font-weight:600;">${total.toFixed(2)}</td>
                        <td style="text-align:center;">
                            <button onclick="deleteRow(${index})" style="color:#ef4444; background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('grandTotal').innerText = grandTotal.toLocaleString('en-MY', {minimumFractionDigits: 2});
        }

        // 3. Update Function
        function updateQty(index, value) {
            let bqItems = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            let newQty = parseInt(value);
            if (newQty < 1) newQty = 1;

            bqItems[index].quantity = newQty;
            localStorage.setItem(CART_KEY, JSON.stringify(bqItems));
            loadBQFromStorage(); // Re-render table
        }

        function deleteRow(index) {
            if(confirm("Padam item ini?")) {
                let bqItems = JSON.parse(localStorage.getItem(CART_KEY)) || [];
                bqItems.splice(index, 1);
                localStorage.setItem(CART_KEY, JSON.stringify(bqItems));
                loadBQFromStorage();
            }
        }

        function clearBQ() {
            if(confirm("Kosongkan semua data projek?")) {
                localStorage.removeItem(CART_KEY);
                loadBQFromStorage();
            }
        }

        // 4. PDF GENERATOR (KOD WAJIB DARI ANDA)
        function generatePDF() {
            const projectData = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            if(projectData.length === 0) return alert("Tiada data untuk dieksport.");

            let bodyData = [];
            
            // Push Headers (Row 1 & 2)
            bodyData.push([
                { text: 'No', style: 'tableHeader', rowSpan: 2, alignment: 'center', margin: [0, 8, 0, 0] },
                { text: 'Keterangan', style: 'tableHeader', rowSpan: 2, alignment: 'center', margin: [0, 8, 0, 0] },
                { text: 'JKKE', style: 'tableHeader', colSpan: 3, alignment: 'center' },
                {}, {}, // Empty for colspan
                { text: 'Kuantiti', style: 'tableHeader', rowSpan: 2, alignment: 'center', margin: [0, 8, 0, 0] },
                { text: 'Harga (RM)', style: 'tableHeader', rowSpan: 2, alignment: 'center', margin: [0, 8, 0, 0] }
            ]);

            bodyData.push([
                {}, {}, // Empty for rowspan
                { text: 'Bhg.', style: 'subHeader', alignment: 'center' },
                { text: 'Bil.', style: 'subHeader', alignment: 'center' },
                { text: 'RM', style: 'subHeader', alignment: 'center' },
                {}, {} // Empty for rowspan
            ]);

            // Push Data Rows
            let totalAmount = 0;
            projectData.forEach((item, index) => {
                let section = item.code.charAt(0);
                let billNo = item.code.substring(1);
                let price = parseFloat(item.price);
                let qty = parseInt(item.quantity) || 1;
                let rowTotal = price * qty;
                totalAmount += rowTotal;

                bodyData.push([
                    { text: index + 1, alignment: 'center' },
                    { text: item.description, style: 'itemDesc' },
                    { text: section, alignment: 'center' },
                    { text: billNo, alignment: 'center' },
                    { text: price.toFixed(2), alignment: 'right' },
                    { text: qty, alignment: 'center' },
                    { text: rowTotal.toFixed(2), alignment: 'right', bold: true }
                ]);
            });

            // Footer Row (Total)
            bodyData.push([
                { text: 'JUMLAH BESAR', colSpan: 6, alignment: 'right', bold: true, fillColor: '#fef9c3' },
                {}, {}, {}, {}, {},
                { text: totalAmount.toFixed(2), alignment: 'right', bold: true, fillColor: '#fef9c3' }
            ]);

            const docDefinition = {
                content: [
                    { text: 'LAMPIRAN C: JADUAL KADAR HARGA (JKKE)', style: 'header', alignment: 'center', margin: [0, 0, 0, 20] },
                    {
                        table: {
                            headerRows: 2,
                            widths: [20, '*', 30, 30, 50, 40, 60],
                            body: bodyData
                        }
                    }
                ],
                styles: {
                    header: { fontSize: 14, bold: true },
                    tableHeader: { bold: true, fontSize: 10, fillColor: '#eeeeee' },
                    subHeader: { bold: true, fontSize: 9, fillColor: '#f9f9f9' },
                    itemDesc: { fontSize: 9 }
                }
            };

            pdfMake.createPdf(docDefinition).download('BQ_JKKE_Rasmi.pdf');
        }
    </script>
</body>
</html>